<script>
  export let data;
  import { toast } from "svelte-sonner";
  import * as Table from "$lib/components/ui/table";
  import { Button } from "$lib/components/ui/button";
  import { Toaster } from "$lib/components/ui/sonner";
  import { Input } from "$lib/components/ui/input";
  import * as Dialog from "$lib/components/ui/dialog";
  import { Label } from "$lib/components/ui/label";

  import DomainRow from "$lib/components/DomainRow.svelte";
  import { invalidateAll } from "$app/navigation";
  import { version } from "$app/environment";
  let newRedirectDialog = false;
</script>

<div class="bg-zinc-900 text-white py-24 flex text-center">
  <div class="m-auto p-6">
    <h1 class="text-3xl font-bold pb-1">
      Hi {data.userInfo.given_name}!
    </h1>
    <h2 class="text-xl font-medium">Here's all your gaycat redirects.</h2>

    <Table.Root>
      <Table.Header>
        <Table.Row>
          <Table.Head class="w-[100px]">Host</Table.Head>
          <Table.Head>Url</Table.Head>
          <Table.Head class="text-right">Options</Table.Head>
        </Table.Row>
      </Table.Header>
      <Table.Body>
        {#each data.result as domain}
          <DomainRow {domain} />
        {/each}
      </Table.Body>
    </Table.Root>

    {#if data.result.length == 0}
      <div class="flex gap-1 items-center">
        <span class="text-gray-400 text-center"
          >No redirects found.<br />Missing a host? Get arti to manually link
          legacy redirects to your account.</span>
      </div>
    {/if}

    <br class="pb-3" />

    <Button variant="default" on:click={() => (newRedirectDialog = true)}>
      New Redirect</Button>
    <Button variant="secondary" href="/api/auth/logout">Sign Out</Button>

    <p class="pt-8 text-zinc-400 text-sm">
      v{version}
      <br />built with &lt;3 by <a href="https://github.com/artifishvr">arti</a>
    </p>

    <!-- Create Redirect Dialog -->
    <Dialog.Root bind:open={newRedirectDialog}>
      <Dialog.Content class="sm:max-w-[425px]">
        <Dialog.Header>
          <Dialog.Title>Create Redirect</Dialog.Title>
          <Dialog.Description>
            Make a new redirect! Click "create" when you're done.
          </Dialog.Description>
        </Dialog.Header>
        <div class="grid gap-4 py-4">
          <div class="grid grid-cols-4 items-center gap-4">
            <Label for="host" class="text-right">Host</Label>
            <Input id="host" placeholder="rick" class="col-span-3" />
          </div>
          <div class="grid grid-cols-4 items-center gap-4">
            <Label for="url" class="text-right">URL</Label>
            <Input
              id="url"
              placeholder="https://youtu.be/dQw4w9WgXcQ"
              class="col-span-3" />
          </div>
        </div>
        <Dialog.Footer>
          <Dialog.Close>
            <Button
              type="submit"
              on:click={async () => {
                toast.info("Creating...");

                if (
                  document.getElementById(`host`).value == "" ||
                  document.getElementById(`url`).value == ""
                )
                  return toast.error("All fields must be filled in!");

                const response = await fetch("/api/redirects/create", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    host: document.getElementById(`host`).value,
                    url: document.getElementById(`url`).value,
                  }),
                });

                if (!response.ok) {
                  toast.error(
                    `${(await response.text()) || response.statusText}`
                  );
                } else {
                  toast.success("Successfully Updated!");

                  invalidateAll();
                }
              }}>Create</Button>
          </Dialog.Close>
        </Dialog.Footer>
      </Dialog.Content>
    </Dialog.Root>
  </div>
</div>

<Toaster />
